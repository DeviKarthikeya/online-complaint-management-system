<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>User Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
          rel="stylesheet">

    <link rel="stylesheet" href="/theme.css">
    <script src="/theme.js"></script>

</head>

<div th:replace="navbar :: body"></div>

<body class="container mt-4 px-2 px-md-4">

<h3>
    <i class="bi bi-person-circle"></i> User Dashboard
</h3>

<!-- Alerts -->
<div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show">
    <span th:text="${successMessage}"></span>
    <button class="btn-close" data-bs-dismiss="alert"></button>
</div>

<div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show">
    <span th:text="${errorMessage}"></span>
    <button class="btn-close" data-bs-dismiss="alert"></button>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white fw-semibold">
                My Complaints
            </div>
            <div class="card-body">
                <h3 th:text="${totalCount}">0</h3>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow">
            <div class="card-header bg-success text-white fw-semibold">
                OPEN
            </div>
            <div class="card-body">
                <h3 th:text="${openCount}">0</h3>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card shadow">
            <div class="card-header bg-danger text-white fw-semibold">
                CLOSED
            </div>
            <div class="card-body">
                <h3 th:text="${closedCount}">0</h3>
            </div>
        </div>
    </div>
</div>

<!-- Raise Complaint -->
<form action="/user/complaint" method="post" class="mb-4">
    <textarea name="description" class="form-control mb-2"
              placeholder="Describe your complaint" required></textarea>
    <button class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Raise Complaint
    </button>
</form>

<div class="d-flex justify-content-end mb-3">
    <a href="/user/export" class="btn btn-success">
        <i class="bi bi-download"></i> Export My Complaints
    </a>
</div>

<!-- Empty State -->
<div th:if="${complaints.size()==0}" class="alert alert-info text-center">
    You have not raised any complaints yet.
</div>

<!-- Table -->
<div class="table-responsive">
    <table th:if="${complaints.size()>0}"
           class="table table-hover table-bordered align-middle shadow-sm">
        <thead class="table-dark text-center">
        <tr>
            <th>ID</th>
            <th>Description</th>
            <th>Status</th>
            <th>Admin Replies</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="c : ${complaints}">
            <td th:text="${c.id}"></td>
            <td th:text="${c.description}"></td>

            <td class="text-center">
                <span class="badge bg-success" th:if="${c.status=='OPEN'}">OPEN</span>
                <span class="badge bg-warning text-dark" th:if="${c.status=='IN_PROGRESS'}">IN PROGRESS</span>
                <span class="badge bg-danger" th:if="${c.status=='CLOSED'}">CLOSED</span>
            </td>

            <td>
                <div style="max-height:200px; overflow-y:auto;">
                    <div th:each="msg : ${#strings.arraySplit(c.adminReplyHistory,'|||')}"
                         class="p-2 mb-2 rounded"
                         style="background:#e9f5ff;border-left:4px solid #0d6efd;">
                        <small th:text="${msg}"></small>
                    </div>
                </div>
            </td>

            <td class="text-center">
                <form th:if="${c.status!='CLOSED'}"
                      th:action="@{/user/complaints/{id}/close(id=${c.id})}" method="post">
                    <button class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-x-circle"></i> Close
                    </button>
                </form>

                <form th:if="${c.status=='CLOSED'}"
                      th:action="@{/user/complaints/{id}/reopen(id=${c.id})}" method="post">
                    <button class="btn btn-sm btn-outline-warning">
                        <i class="bi bi-arrow-repeat"></i> Reopen
                    </button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<!-- Footer -->
<div th:replace="footer :: body"></div>

</body>
</html>
